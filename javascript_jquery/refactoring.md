# ReactNativeのリファクタリング

## 1. リファクタリングの主要ポイント

### ① 巨大な State の整理と「カスタム Hook」への抽出

現在、20個以上の `useState` が並んでいます。これを「役割」ごとにカスタム Hook として外に切り出すと、`TakePhoto.js` の見通しが劇的に良くなります。

* **`useCameraSettings.js`**: `cameraType`, `flashMode`, `pictureSize` 等の管理。
* **`usePhotoGallery.js`**: `pictures` 配列の管理、ファイルシステムへの保存・読み込み（`savePictures`, `loadPictures`）。
* **`useGenerator.js`**: GIF/MP4 生成ロジックとプレビュー状態の管理。

### ② ロジックと UI の分離

`takePictureAsync` の後のリサイズ処理（`manipulateAsync`）や、保存先パスの計算などは、コンポーネントの中に書くのではなく、前述のカスタム Hook や専用のユーティリティ関数（`cameraUtils.js` 等）に移動させます。これにより、UI側は「ボタンが押されたらこの関数を呼ぶだけ」というシンプルな形になります。

但し、コンポーネント関数内にユーティリティ関数を書くときは、毎回新しく関数が作られ、子コンポーネントにpropsとして付与するのであれば余計なレンダリングが発生するのでuseCallbackを使用する事。

ごくシンプルなコールバックであればそのままインラインで書くのもあり。

### ③ 条件分岐（三項演算子）の整理

`return` 文の中にある `isPreview && enableGenMode == 'gif' ? ... : ...` というネストした三項演算子は、可読性を著しく下げます。
「プレビュー画面」「カメラ画面」「ローディング画面」をそれぞれ独立したコンポーネントにするか、変数に代入してから表示することでスッキリします。

### ④ パフォーマンス最適化

* **画像の配列管理:** `pictures` ステートに Base64 文字列を大量に入れると、メモリを圧迫し動作が重くなります。原則として「ファイルパス（URI）」のみを管理し、生成の直前だけ Base64 に変換するか、ネイティブ側でパスを渡して処理するのが理想的です。
* **メモ化:** `carouselItem` などのレンダリング関数を `useCallback` や `React.memo` で保護し、不要な再レンダリングを防ぎます。

---

## 2. コンポーネントを切り出す基準

「前にも使ったから」という再利用性以外にも、以下の 4 つの基準で考えるとスムーズです。

### ① 「1つの役割」に集約されているか（単一責任の原則）

例えば、**「全削除の確認ダイアログ」**は、カメラのロジックとは無関係です。

* **基準:** 「そのコードの目的が、メインの機能（撮影）とズレているか？」
* **切り出し例:** `ConfirmDialog.js`

### ② 1つのファイルが長すぎる（目安：300行以上）

現在の 650行は、1人で保守するには限界に近いサイズです。

* **基準:** 「目的の場所を探すのに 5秒以上スクロールが必要か？」
* **切り出し例:** `CameraControls.js`（ボタン類をまとめる）、`PhotoCarousel.js`

### ③ 状態（State）のスコープを限定したいとき

現在のコードでは、カルーセルを 1コマ動かすだけで、関係のないカメラ全体が再レンダリングされる可能性があります。

* **基準:** 「そのステート変更は、画面全体の更新が必要か？それとも一部だけでいいか？」
* **切り出し例:** `PhotoCarousel.js` にステートを閉じ込める。

### ④ 複雑な三項演算子や条件分岐が現れたとき

* **基準:** 「JSXの中で `? :` が 2つ以上重なったら切り出し時」
* **切り出し例:** `PreviewSwitcher.js`

---

## 3. 具体的な構成案（リファクタリング後）

以下のような構成に整理すると、保守性が格段に上がります。

```
src/
 ├── hooks/
 │    ├── useCameraManager.js   (カメラ起動・サイズ・反転管理)
 │    └── useFileStorage.js     (FileSystemへの保存・復元)
 ├── components/
 │    ├── CameraView.js         (Expo Camera本体とオーバーレイ)
 │    ├── ControlButtons.js     (シャッター、反転、ライト等のボタン群)
 │    ├── ThumbnailCarousel.js  (撮影済み画像の一覧)
 │    └── DeleteDialog.js       (削除確認)
 └── TakePhoto.js               (これらを組み合わせるだけの親)

```

### 次の一歩としてのおすすめ

まずは、**「削除確認ダイアログ（trashDialogVisible 周り）」**を別コンポーネントに切り出すことから始めてみてはいかがでしょうか？
一番ロジックとの結合が弱いため、切り出しの練習に最適です。

もしよろしければ、**特定のパーツ（例：カメラ設定の Hook 化など）に絞って、具体的な書き換え例を作成しましょうか？**