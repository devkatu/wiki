<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="common.css">
<title>非同期処理</title>
</head>
<body>
  <div class="title">
    <p>javascriptはシングルスレッドだが、webWorkerというものを使うと別のスレッドを立ててそちらにタスクの処理を
      任せるようなことができるようになる。しかしこれでは複数のタスクの結果を必要とする場合にはうまく機能しない</p>
    <input type="button" id="worker" value="workerｽﾀｰﾄ">
  </div>
  <div class="outer">
    <pre><code>
  const worker_start = document.querySelector('#worker');
  const worker = new Worker('worker.js');  //workerインスタンスの作成

  worker_start.addEventListener('click',function(){
    worker.postMessage('go');  //postMessageメソッドでインスタンス作成時に渡したスクリプトを実行できる
                               //これでスクリプト側でonmessageの関数を実行する
  });
  worker.onmessage = (e) => {
    alert(e.data);  //postMessageで開始したスクリプトが終了(スクリプト側のpostMessage実行のタイミング)
                    //するとonmessageイベントが発火する
  };
    </code></pre>
    <pre>

  全体イメージ
  メインスレッド　：postMessage('go');　     　onmessageイベント
                      ↓                          ↑
  ワーカースレッド：onmessageイベント　　---->　postMessage(data);
    </pre>
  </div>

  <div class="title">
    <p>promise</p>
    <input type="button" id="promise_start" value="promiseｽﾀｰﾄ">
  </div>
  <div class="outer">
    <pre><code>

    </code></pre>
  </div>

  <div class="title">
    <p>async/await</p>
    <input type="button" id="async_start" value="asyncｽﾀｰﾄ">
  </div>
  <pre><code>

  </code></pre>

  <script type="text/javascript">
  const worker_start = document.querySelector('#worker');
  // const worker = new Worker('worker.js');
  // originのやつでローカル環境で実行するとerror

  worker_start.addEventListener('click',function(){
    worker.postMessage('go');
  });
  worker.onmessage = (e) => {
    alert(e.data);
  };

  function myPromise(param){
    return new Promise((resolve,reject) => {
      setTimeout(() => {
        if(Math.random() < 0.3){
          resolve(param + '成功！');
        }else{
          reject(new Error('error発生です'));
        }
      },1000);
    });
  }

  let promise_start = document.querySelector('#promise_start');
  promise_start.addEventListener('click',() => {
    let mypromise = myPromise('promise');
    mypromise.then((str) => {
      alert(str);
    })
    .catch((str) => {
      alert(str);
    });
  });


  let asyncpromise = new Promise((resolve, reject) => {
    // setTimeout(resolve,5000,'foo');
    setTimeout(() => {
      resolve('async終了');
    },3000);
  });

  async function asyncfunc(){
    let str = await asyncpromise;
    alert(str);
  }

  let async_start = document.querySelector('#async_start');
  async_start.addEventListener('click', () => {
    asyncfunc();
  });

  </script>
</body>
</html>
