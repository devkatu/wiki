<!DOCTYPE HTML>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>クロージャとonclick</title>
<style type="text/css">
</style>
</head>
<body>

<h3>クロージャとonclick</h3>
<ul id="z01" >
<li><a href="#">0</a></li><!-- 4 -->
<li><a href="#">1</a></li><!-- 4 -->
<li><a href="#">2</a></li><!-- 4 -->
<li><a href="#">3</a></li><!-- 4 -->
</ul>

<script type="text/javascript">
window.onload=function(){
  var element = document.getElementById("z01").getElementsByTagName("li");
  for(var i=0;i<element.length;i+=1){
    add_the_handlers(element);
  }
}
/*
// 誤り。これはクロージャになっておらず、for文終了後のi…4にアクセスしてしまう
var add_the_handlers = function (nodes) {
    var i;
    for (i = 0; i < nodes.length; i += 1) {
        nodes[i].onclick = function (e) {
            alert(i);
        };
    }
};
*/

//パターン1
// onclickに代入される即時関数にadd_the_handlers関数で定義した
// 変数iを渡す(コピー)事でこの即時関数でのローカル変数となり
// ハンドラとして返される内部の関数はその外部のiにアクセスすることになる
var add_the_handlers = function (nodes) {
    var i;
    for (i = 0; i < nodes.length; i += 1) {
        nodes[i].onclick = (function (i) {
            return function (e) {
                alert(i);  //ここがイベントハンドラとなる。
            };
        })(i);  //即時関数を定義してその場で実行している
    }
};

//パターン2
var add_the_handlers = function (nodes) {
    var helper = function (i) {
       return function (e) {
          alert(i);
       };
    };
    var i;
    for (i = 0; i < nodes.length; i += 1) {
        nodes[i].onclick = helper(i);
    }
};

//パターン3
var add_the_handlers = function (nodes) {
    var i;
    for (i = 0; i < nodes.length; i += 1) {
      (function(){
        var j=i;
        nodes[i].onclick = function (e) {
            alert(j);
        };
      }());
    }
};

//パターン4
var add_the_handlers = function (nodes) {
    var i;
    for (i = 0; i < nodes.length; i += 1) {
      (function(i){
        nodes[i].onclick = function (e) {
            alert(i);
        };
      }(i));
    }
};

</script>
</body>
</html>
